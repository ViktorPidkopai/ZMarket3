<!DOCTYPE html>
<html>

<head lang="en">

    <meta charset="utf-8"/>
    <title>Buy!</title>
    <script src="js/jquery-2.1.4.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/bootstrap.min.js"></script>

</head>

<body>

<script type="application/javascript">

    $.getJSON("rest/product", function (data) {
        fillTable(data);
    });

    $.getJSON("rest/category", function (data) {
        addProductButtons(data);
    });

    function addProductButtons(data) {
        addAllButton();
        $.each(data, function (index, value) {
            var btn = document.createElement("button");
            var btnLabel = document.createTextNode(value.title);
            btn.appendChild(btnLabel);
            btn.setAttribute("class", "btn btn-default btn-block");
            btn.setAttribute("type", "submit");
            btn.setAttribute("id", "btn" + value.title);
            btn.onclick = function () {
                showByCategory(value.title)
            };
            var liWrapper = document.createElement("li");
            var pWrapper = document.createElement("p");
            pWrapper.appendChild(btn);
            liWrapper.appendChild(pWrapper);
            document.getElementById("productButtonGroup").appendChild(liWrapper);
        });
    }
    function addAllButton() {
        var btn = document.createElement("button");
        var btnLabel = document.createTextNode("All");
        btn.appendChild(btnLabel);
        btn.setAttribute("class", "btn btn-default btn-block");
        btn.setAttribute("type", "submit");
        btn.setAttribute("id", "allProductsBtn");
        btn.onclick = function () {
            showByCategory("All")
        };
        var liWrapper = document.createElement("li");
        var pWrapper = document.createElement("p");
        pWrapper.appendChild(btn);
        liWrapper.appendChild(pWrapper);
        document.getElementById("productButtonGroup").appendChild(liWrapper);
    }

    function showByCategory(categoryTitle) {
        console.log("show by category: " + categoryTitle);
        if (categoryTitle == "All") {
            showAll();
            setCurrentCategory(categoryTitle);
        } else {
            $.getJSON("rest/product/category/" + categoryTitle, function (data) {
                fillTable(data);
            });
            setCurrentCategory(categoryTitle);
        }
    }

    function showAll() {
        console.log("All btn clicked.");
        $.getJSON("rest/product", function (data) {
            fillTable(data);
        });
    }

    function setCurrentCategory(categoryTitle) {
        currentCategory = categoryTitle;
        console.log("currect CATEGORY = " + currentCategory);
    }

    function findByPrice() {
        var minPriceValue = document.getElementById("minPriceInput").value;
        var maxPriceValue = document.getElementById("maxPriceInput").value;
        if ((minPriceValue != '' | maxPriceValue != '') && minPriceValue < maxPriceValue) {
            console.log("PRICE FILTER btn clicked. min = " + minPriceValue + "; max = " + maxPriceValue);
            $.ajax({
                type: "GET",
                url: "rest/product/" + minPriceValue + "/" + maxPriceValue,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    fillTable(data);
                }
            });
            clearPriceFilterForm();
        } else {
            console.log("ERROR min = " + minPriceValue + "; max = " + maxPriceValue);
            clearPriceFilterForm();
        }
    }

    function findByName() {
        var nameForSearch = document.getElementById("searchInput").value;
        console.log("SEARCH btn clicked. name = " + nameForSearch);
        $.ajax({
            type: "GET",
            url: "rest/product/search/" + nameForSearch,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                fillTable(data);
            }
        });
        clearSearchForm();
    }

    function clearPriceFilterForm() {
        document.getElementById("minPriceInput").value = '';
        document.getElementById("maxPriceInput").value = '';
    }

    function clearSearchForm() {
        document.getElementById("searchInput").value = '';
    }

    $(document).on("click", '.addToCartBtn', function () {
//        enableCartButton();
        var id = $(this).attr('id');
        console.log("ADDTOCART btn clicked; id = " + id);
        addItemToCart(id);
        setCartLabel();
        $.ajax({
            type: "POST",
            url: "rest/cart",
            data: id,
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        });
    });

    function fillTable(data) {
        var tableHead = '<thead><tr>' +
                '<th>' + 'id' + '</th>' +
                '<th>' + 'Name' + '</th>' +
                '<th>' + 'Description' + '</th>' +
                '<th>' + 'Price' + '</th>' +
                '<th>' + 'Actions' + '</th></tr></thead>';
        var tableBody = '';
        $.each(data, function (index, value) {
            tableBody += '<tr>' +
                    '<td>' + value.id + '</td>' +
                    '<td>' + value.name + '</td>' +
                    '<td>' + value.description + '</td>' +
                    '<td>' + value.price / 100 + '</td>' +
                    '<td><button type="button" class="btn btn-primary btn-xs addToCartBtn" id = "' + value.id + '">' +
                    'Add to cart' +
                    '</button></td></tr>';
        });

        $('#itemsTable').html('').append(tableHead).append('<tbody>').append(tableBody).append('</tbody>');

        console.log("fillTable() OK");
    }

    function refreshTable() {
        console.log("refreshTable() OK");
        $.getJSON("rest/product", function (data) {
            fillTable(data);
        });
    }

    function addItemToCart(id) {
        itemsInCart.push(id);
    }

    function setCartLabel() {
        $("#cart_label").text(itemsInCart.length + " item(s) in cart");
    }

    //    function enableCartButton() {
    //        document.getElementById("cart_btn").disabled = false;
    //    }

    var itemsInCart = [];
    var currentCategory;

</script>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="https://github.com/ViktorPidkopai/ZMarket4" target="_blank">ZMarket</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">
                <li><a href="cart.html">Cart</a></li>
                <li><a href="">Logout</a>
                    <!--<button type="button" class="btn btn-default" id="logoutBtn">Logout</button>-->
                </li>
            </ul>
            <form class="navbar-form navbar-right" id="searchForm">
                <input class="form-control" placeholder="Search..." type="text" id="searchInput">
                <button type="button" class="btn btn-default" id="searchBtn" onClick="findByName();">Go!</button>
            </form>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-3">
            <ul class="nav nav-sidebar" id="productButtonGroup"></ul>
            <ul class="nav nav-sidebar" id="priceFilter">
                <li>
                    <form>
                        <div class="form-group">
                            <input type="number" class="form-control" id="minPriceInput" placeholder="min price"
                                   required>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control" id="maxPriceInput" placeholder="max price"
                                   required>
                        </div>
                        <button type="button" class="btn btn-default btn-block" id="findByPriceBtn"
                                onclick="findByPrice();"><span class="glyphicon glyphicon-search"
                                                               aria-hidden="true"></span>&emsp;Find!
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        <div class="col-md-9">
            <table class="table table-hover" id="itemsTable">

            </table>
        </div>
    </div>
</div>

<footer class="text-center">
    <a href="https://github.com/ViktorPidkopai" target="_blank">(C) Viktor Pidkopai 2015</a>
</footer>

</body>
</html>